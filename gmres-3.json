{"kind":"Notebook","sha256":"22e78f5f3fc0e4c721513965c8e767a4b2913e9d446b5904064eb48248706c31","slug":"gmres-3","location":"/chapter8/section8/python/gmres.ipynb","dependencies":[],"frontmatter":{"numbering":{"heading_1":{"enabled":false},"heading_2":{"enabled":false},"heading_3":{"enabled":false},"heading_4":{"enabled":false},"heading_5":{"enabled":false},"heading_6":{"enabled":false}},"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"authors":[{"nameParsed":{"literal":"Tobin A. Driscoll","given":"Tobin A.","family":"Driscoll"},"name":"Tobin A. Driscoll","email":"driscoll@udel.edu","id":"contributors-myst-generated-uid-0","corresponding":true},{"nameParsed":{"literal":"Richard J. Braun","given":"Richard J.","family":"Braun"},"name":"Richard J. Braun","id":"contributors-myst-generated-uid-1"}],"github":"https://github.com/fncbook/fnc","math":{"\\float":{"macro":"\\mathbb{F}"},"\\real":{"macro":"\\mathbb{R}"},"\\complex":{"macro":"\\mathbb{C}"},"\\nat":{"macro":"\\mathbb{N}"},"\\integer":{"macro":"\\mathbb{Z}"},"\\rmn":{"macro":"\\mathbb{R}^{#1 \\times #2}"},"\\dd":{"macro":"\\frac{d #1}{d #2}"},"\\ddd":{"macro":"\\frac{d^2 #1}{d #2^2}"},"\\pp":{"macro":"\\frac{\\partial #1}{\\partial #2}"},"\\ppp":{"macro":"\\frac{\\partial^2 #1}{\\partial #2^2}"},"\\ppdd":{"macro":"\\frac{\\partial^2 #1}{\\partial #2 \\partial #3}"},"\\abs":{"macro":"\\left\\lvert #1 \\right\\rvert"},"\\norm":{"macro":"\\left\\lVert #1 \\right\\rVert"},"\\twonorm":{"macro":"\\norm{#1}_2"},"\\onenorm":{"macro":"\\norm{#1}_1"},"\\infnorm":{"macro":"\\norm{#1}_\\infty"},"\\anynorm":{"macro":"\\norm{#1}_#2"},"\\innerprod":{"macro":"\\langle #1,#2 \\rangle"},"\\pr":{"macro":"^{(#1)}"},"\\kron":{"macro":"#1 \\otimes #2"},"\\eye":{"macro":"\\mathbf{e}_#1"},"\\meye":{"macro":"\\mathbf{I}"},"\\Qhat":{"macro":"\\hat{\\mathbf{Q}}"},"\\Rhat":{"macro":"\\hat{\\mathbf{R}}"},"\\bfalpha":{"macro":"\\mathbf{alpha}"},"\\bfdelta":{"macro":"\\mathbf{delta}"},"\\bfzero":{"macro":"\\boldsymbol{0}"},"\\macheps":{"macro":"\\epsilon_\\text{mach}"},"\\fl":{"macro":"\\operatorname{fl}"},"\\diag":{"macro":"\\operatorname{diag}"},"\\ign":{"macro":"\\operatorname{sign}"},"\\Re":{"macro":"\\operatorname{Re}"},"\\Im":{"macro":"\\operatorname{Im}"},"\\ee":{"macro":"\\times 10^"},"\\lnorm":{"macro":"\\|"},"\\rnorm":{"macro":"\\|"},"\\floor":{"macro":"\\lfloor#1\\rfloor"},"\\cI":{"macro":"\\mathcal{I}"},"\\mtx":{"macro":"\\operatorname{mtx}"},"\\myvec":{"macro":"\\operatorname{vec}"},"\\argmin":{"macro":"\\operatorname{argmin}"}},"abbreviations":{"IVP":"initial-value problem","BVP":"boundary-value problem","ONC":"matrix with orthonormal columns","SVD":"singular value decomposition","EVD":"eigenvalue decomposition","SPD":"symmetric positive definite","HPD":"hermitian positive definite","PDE":"partial differential equation","ODE":"ordinary differential equation"},"exports":[{"format":"ipynb","filename":"gmres.ipynb","url":"/fnc/build/gmres-7068458b4f1f5db8eb0ac98d044e7ad6.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:34.735223Z","iopub.status.busy":"2025-01-11T16:26:34.735056Z","iopub.status.idle":"2025-01-11T16:26:35.124948Z","shell.execute_reply":"2025-01-11T16:26:35.124614Z"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"exec(open(\"../../../python/FNC_init.py\").read())","visibility":"show","key":"qo95PNc7XV"},{"type":"output","id":"lQurCkGoJOVLI4JK4G7q5","data":[],"visibility":"show","key":"n0v6PGM08c"}],"visibility":"remove","key":"bZnhmiUPnD"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Demo ","key":"bb2B0pzEk7"},{"type":"text","value":"8.8.2","key":"GjMof87MI7"}],"key":"p5nA2nVpDD"}],"identifier":"demo-precond-gmres","label":"demo-precond-gmres","kind":"proof:example","template":"Example %s","enumerator":"8.8.2","resolved":true,"html_id":"demo-precond-gmres","remote":true,"url":"/precond","dataUrl":"/precond.json","key":"DhDPU2UYIL"}],"key":"lqspjsIV3b"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here is a random nonsymmetric matrix.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"r81DbbmdTd"}],"key":"G4rS152Jbp"}],"key":"LGDvU1KeMo"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:35.126605Z","iopub.status.busy":"2025-01-11T16:26:35.126469Z","iopub.status.idle":"2025-01-11T16:26:36.684694Z","shell.execute_reply":"2025-01-11T16:26:36.684373Z"}},"children":[{"type":"code","lang":"python","executable":true,"value":"import scipy.sparse as sp\nn = 8000\nA = 2.8 * sp.eye(n) + sp.rand(n, n, 0.002)","key":"q74EwK9CWx"},{"type":"output","id":"n62HrcyBr8B92mrpb8ib_","data":[],"key":"Y5jlzxXukM"}],"key":"BcN4pX3bhh"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Without a preconditioner, GMRES can solve a system with this matrix.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"t823FWZkLV"}],"key":"VeKV92uFZm"}],"key":"YCJyOY52G8"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:36.686244Z","iopub.status.busy":"2025-01-11T16:26:36.686136Z","iopub.status.idle":"2025-01-11T16:26:36.731767Z","shell.execute_reply":"2025-01-11T16:26:36.731493Z"}},"children":[{"type":"code","lang":"python","executable":true,"value":"from scipy.sparse.linalg import gmres\n\nb = random.rand(n)\nhist = lambda rvec: resid.append(norm(rvec))\nresid = [1.]\n\nstart = timer()\nx, flag = gmres(A, b, maxiter=300, rtol=1e-10, restart=50, callback=hist)\nprint(f\"time for plain GMRES: {timer() - start:.3f} sec\")\nresid_plain = resid.copy()","key":"lxqqAsfOYJ"},{"type":"output","id":"bRwm0bLwi6BYGB6c0rJcd","data":[{"name":"stdout","output_type":"stream","text":"time for plain GMRES: 0.043 sec\n"}],"key":"rl9buFg7X1"}],"key":"nwgIZ7zg2r"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The following version of incomplete LU factorization drops all sufficiently small values (i.e., replaces them with zeros). This keeps the number of nonzeros in the factors under control.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vvofIwIvqY"}],"indexEntries":[{"entry":"Python","subEntry":{"value":"spilu","kind":"entry"},"emphasis":true}],"label":"index-PFV7HFylAl","identifier":"index-pfv7hfylal","html_id":"index-pfv7hfylal","key":"MYyAaFbkPV"}],"key":"We4TBxfc40"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:36.732970Z","iopub.status.busy":"2025-01-11T16:26:36.732885Z","iopub.status.idle":"2025-01-11T16:26:37.049107Z","shell.execute_reply":"2025-01-11T16:26:37.048800Z"}},"children":[{"type":"code","lang":"python","executable":true,"value":"from scipy.sparse.linalg import spilu\niLU = spilu(A, drop_tol=0.2)\nprint(f\"Factors have {iLU.nnz} nonzeros, while A has {A.nnz}\")","key":"KB89gyjKAc"},{"type":"output","id":"OTqvyslWpXJ8leEW3Cejt","data":[{"name":"stderr","output_type":"stream","text":"/var/folders/gc/0752xrm56pnf0r0dsrn5370c0000gr/T/ipykernel_16463/769705972.py:2: SparseEfficiencyWarning: spilu converted its input to CSC format\n  iLU = spilu(A, drop_tol=0.2)\n"},{"name":"stdout","output_type":"stream","text":"Factors have 90808 nonzeros, while A has 135982\n"}],"key":"jUsDcDzqpN"}],"key":"ITHRWiTvTI"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The result is not a true factorization of the original matrix. However, it’s close enough for an approximate inverse in a preconditioner.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BLWcZay2Vp"}],"key":"WBV5bOGt92"}],"key":"FEarH7611M"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:37.050521Z","iopub.status.busy":"2025-01-11T16:26:37.050432Z","iopub.status.idle":"2025-01-11T16:26:37.084077Z","shell.execute_reply":"2025-01-11T16:26:37.083782Z"}},"children":[{"type":"code","lang":"python","executable":true,"value":"from scipy.sparse.linalg import LinearOperator\nprec = LinearOperator((n, n), matvec=lambda y: iLU.solve(y))\n\nresid = [1.];  start = timer()\nx, flag = gmres(A, b, M=prec, maxiter=300, rtol=1e-10, restart=50, callback=hist)\nprint(f\"time for preconditioned GMRES: {timer() - start:.3f} sec\")\nresid_prec = resid","key":"lBFY2ZkFUv"},{"type":"output","id":"E8dBtVgOhpoB8C-9qKmSX","data":[{"name":"stdout","output_type":"stream","text":"time for preconditioned GMRES: 0.031 sec\n"}],"key":"dpHWUM5da3"}],"key":"MeoN8cPodf"},{"type":"block","kind":"notebook-code","data":{"execution":{"iopub.execute_input":"2025-01-11T16:26:37.085505Z","iopub.status.busy":"2025-01-11T16:26:37.085379Z","iopub.status.idle":"2025-01-11T16:26:37.247351Z","shell.execute_reply":"2025-01-11T16:26:37.247092Z"},"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"semilogy(resid_plain, label=\"no prec.\")\nsemilogy(resid_prec, label=\"iLU prec.\")\nxlabel(\"iteration number\"),  ylabel(\"residual norm\")\nlegend()\ntitle(\"GMRES convergence compared\");","visibility":"hide","key":"B9KYZxg5Eu"},{"type":"output","id":"r2UfhOd6ffLusPBH1lF-D","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"a4438266812e88076db449c977c5c693","path":"/fnc/build/a4438266812e88076db449c977c5c693.png"},"text/plain":{"content":"<Figure size 700x400 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"ACaGQxQioE"}],"visibility":"show","key":"Rg3RBjnTke"}],"key":"oSOgzRnu12"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Diagonal","url":"/diagonal-2","group":"Chapter 8"},"next":{"title":"Lagrange","url":"/lagrange-2","group":"Chapter 9"}}},"domain":"http://localhost:3000"}